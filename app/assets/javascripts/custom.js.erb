// Google Maps
let isMapsApiLoaded = false;

function checkMapsTurbolinks() {
    <% unless Rails.env.test? %>
      if (isMapsApiLoaded) {
          initMap();
      } else {
          let script = document.createElement("script");
          script.type = "text/javascript";
          script.src = "https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.gmap[:js_key] %>&callback=initMap";
          document.body.appendChild(script);
      }
    <% end %>
}

function openInfoWindow(data, map, marker, infoWindow, index) {
    let item = data[index];
    item['infoWindow'] = infoWindow;

    marker.addListener('click', function (e) {
        closeInfoWindows(data);
        infoWindow.open(map, marker)
    });
}

function closeInfoWindows(data) {
    for (i = 0; i < data.length; i++) {
        data[i]['infoWindow'].close();
    }
}

// Header
$(document).on('turbolinks:load', function () {
    $('.dropdown-toggle').dropdown()
});

// Search Suggestion
$(document).ready(function () {
    $('#parlors_search_field').autocomplete({
        source: function(request, response) {
            const MAX_NUM = 5;

            $.ajax({
                type: 'GET',
                url: '/parlors/suggest',
                data: { keyword: request.term, max_num: MAX_NUM },
                dataType: 'json'
            })
            .done(function(data) {
                response(data);
            })
            .fail(function(data) {
                response([]);
            });
        }
    });
});
